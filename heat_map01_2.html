<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Street Segments by PMV</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <!-- Mapbox GL JS & Threebox -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/jscastro76/threebox@v.2.2.2/dist/threebox.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/jscastro76/threebox@v.2.2.2/dist/threebox.css" rel="stylesheet" />

    <!-- jQuery + è®€ CSV çš„å¤–æ› -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.21/jquery.csv.min.js"></script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        
        .mapboxgl-ctrl-reset {
        font-size: 18px; line-height: 28px;    /* æ–‡å­—ç½®ä¸­ */
        }
        .mapboxgl-ctrl-reset::before {
        content: "â†º";               /* ä¹Ÿå¯æ›æˆ âŒ‚ æˆ– ğŸ  ç­‰ */
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        const blockLabels = [
        { block: 50,  text: 'A',   height: 30 },
        { block: 4, text: 'B',   height: 30 },
        { block: 103, text: 'C', height: 30 },
        { block: 60, text: 'D', height: 30 }
        ];




        /* ----------- åœ°åœ–åŸºæœ¬è¨­å®š ----------- */
        const initialView = {                      
            center: [121.5305, 25.0405],               
            zoom: 15.8,
            pitch: 0,
            bearing: 0
        };

        mapboxgl.accessToken =
            "pk.eyJ1IjoicGlhb3BpYW9lbiIsImEiOiJjbTlsa2Y2d28wM2d4MmxyNzhqem12MWd1In0.NbcsNNsBZtV-pLab8nBtPg";
        
        const map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/piaopiaoen/cm9vnl58100iu01sp9ty8fqez",
            center: initialView.center,
            zoom: initialView.zoom,
            pitch: initialView.pitch,
            bearing: initialView.bearing,
            antialias: true,
            localIdeographFontFamily: "Noto Sans CJK TC",
            language: "zh-Hant"
        });
        /* â˜…â˜…â˜… åŠ å…¥æŒ‡åŒ—é‡ â˜…â˜…â˜… */
        const compassControl = new mapboxgl.NavigationControl({
            showZoom: false,        // ä¸é¡¯ç¤º + / âˆ’ æŒ‰éˆ•ï¼›å¦‚éœ€å°±æ”¹ç‚º true
            visualizePitch: true    // ä¿ç•™ pitch æŒ‡ç¤º
        });
        map.addControl(compassControl, 'top-left'); // å¯æ”¹ 'top-right' ç­‰ä½ç½®
        /* â˜…â˜…â˜… æŒ‡åŒ—é‡çµæŸ â˜…â˜…â˜… */


     class ResetViewControl {
        onAdd(map) {
            this._map = map;

            // å¤–å±¤å®¹å™¨ï¼ˆä¿ç•™ Mapbox æ¨£å¼ï¼‰
            const wrapper = document.createElement('div');
            wrapper.className = 'mapboxgl-ctrl mapboxgl-ctrl-group';

            // æŒ‰éˆ•
            const btn = document.createElement('button');
            btn.className = 'mapboxgl-ctrl-icon mapboxgl-ctrl-reset';
            btn.type  = 'button';
            btn.title = 'å›åˆ°åˆå§‹è¦–è§’';

            // é»æ“Šäº‹ä»¶ï¼šé£›å›åˆå§‹åƒæ•¸
            btn.onclick = () => {
            map.flyTo({
                center:  initialView.center,
                zoom:    initialView.zoom,
                pitch:   initialView.pitch,
                bearing: initialView.bearing,
                duration: 1000            // å‹•ç•« 1 ç§’
            });
            };

            wrapper.appendChild(btn);
            this._btn = btn;
            return wrapper;
        }
        
        onRemove() {
            this._btn.parentNode.remove();
            this._map = undefined;
        }
    }
        map.addControl(new ResetViewControl(), 'top-left');





        /* ----------- é¡è‰²å°ç…§ ----------- */
        const baseColors = [
            "#b2182b", //  3 ä»¥ä¸Š (hot)
            "#ef8a62", //  2 ~ 2.5
            "#fddbc7", //  1 ~ 1.5
            "#ffffff", // -0.5 ~ 0.5
            "#d1e5f0", // -1 ~ -0.5
            "#67a9cf", // -2 ~ -1
            "#2166ac"  // -3 ä»¥ä¸‹ (cold)
        ];
        // è½‰ä¸‰ç¶­ç·šæ€§ç©ºé–“è‰²ç¢¼ï¼ˆThree.js å…§éƒ¨ä½¿ç”¨ï¼‰
        const colors = baseColors.map(hex =>
            new THREE.Color(hex).convertSRGBToLinear().getStyle()
        );

        function getPMVColor(pmv) {
            if (pmv >= 2.5) return colors[0];
            if (pmv >= 1.5) return colors[1];
            if (pmv >= 0.5) return colors[2];
            if (pmv >= -0.5) return colors[3];
            if (pmv >= -1.5) return colors[4];
            if (pmv >= -2.5) return colors[5];
            return colors[6];
        }

        function calculateNewCoordinates(lat1, lon1, distance, angle){
            const R = 6371000, d = distance / R, brng = angle * Math.PI/180;
            const Ï†1 = lat1 * Math.PI/180, Î»1 = lon1 * Math.PI/180;
            const Ï†2 = Math.asin(Math.sin(Ï†1)*Math.cos(d)+Math.cos(Ï†1)*Math.sin(d)*Math.cos(brng));
            const Î»2 = Î»1 + Math.atan2(Math.sin(brng)*Math.sin(d)*Math.cos(Ï†1),
                                        Math.cos(d)-Math.sin(Ï†1)*Math.sin(Ï†2));
            return { lat: Ï†2*180/Math.PI, lon: Î»2*180/Math.PI };
        }

        /* â˜…â˜…â˜… 3. å»ºç«‹å–®ä¸€ 3D æ–‡å­— â˜…â˜…â˜… */
        function makeTopLabel(font, lon, lat, text, height){
            const geo = new THREE.TextGeometry(text,{font,size:15,height:0.3});
            const mat = new THREE.MeshBasicMaterial({color:'#FFD700'});
            const mesh = new THREE.Mesh(geo,mat);

            const glowGeo = new THREE.TextGeometry(text,{font,size:15.5,height:0.1});
            const glowMat = new THREE.MeshBasicMaterial({color:'#FFD700',transparent:true,opacity:0.5});
            const glow = new THREE.Mesh(glowGeo,glowMat);

            geo.center();      glowGeo.center();
            // geo.rotateX(Math.PI/2);      
            // glowGeo.rotateX(Math.PI/2);  
            geo.rotateZ(Math.PI);
            glowGeo.rotateZ(Math.PI);

            const grp = new THREE.Group(); grp.add(glow); grp.add(mesh);
            const obj3d = tb.Object3D({obj:grp,units:'meters'});
            obj3d.setCoords([lon,lat,height]);
            tb.add(obj3d);
        }

        /* â˜…â˜…â˜… 4. ä¾ blockLabels æ‰¹æ¬¡åŠ æ¨™ç±¤ â˜…â˜…â˜… */
        function addAllLabels(font,data){
        blockLabels.forEach(b=>{
            const hit = data.find(d=>Number(d.Block)===b.block);
            if(hit) makeTopLabel(font,+hit.lon,+hit.lat,b.text,b.height);
        });
        }
    
 
/* ----------- Mapbox èˆ‡ Threebox ä¸»ç¨‹å¼ ----------- */
        map.on('load', () => {
        map.addLayer({
            id: 'custom_layer',
            type: 'custom',
            renderingMode: '3d',
            onAdd: (map, ctx) => {
            window.tb = new Threebox(map, ctx, { defaultLights:false, realSunlight:false });
            tb.add(new THREE.AmbientLight(0xffffff, 2));

            /* å…ˆè¼‰å­—å‹ â†’ å†è¼‰è³‡æ–™ â†’ ç•«ç·š + æ¨™ç±¤ */
            new THREE.FontLoader().load(
                'https://cdn.rawgit.com/mrdoob/three.js/master/examples/fonts/helvetiker_regular.typeface.json',
                font => {
                $.getJSON('./data/0910M_P3.json', data => {
                    data.forEach(r => {
                    tb.add(tb.line({
                        geometry: [[+r.start_lon, +r.start_lat, 1], [+r.end_lon, +r.end_lat, 1]],
                        color: getPMVColor(+parseFloat(r["pmv"].toFixed(1))),
                        width: 10
                    }));
                    });
                    addAllLabels(font, data);   // åŠ ä¸Š A/B/C/D æµ®æ¨™
                });
                });
            },
            render: () => tb && tb.update()
        });
        });
    
    
    </script>
</body>

</html>
