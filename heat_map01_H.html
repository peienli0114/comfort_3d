<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Street Segments by PMV</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <!-- Mapbox GL JS & Threebox -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/jscastro76/threebox@v.2.2.2/dist/threebox.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/jscastro76/threebox@v.2.2.2/dist/threebox.css" rel="stylesheet" />

    <!-- jQuery + 讀 CSV 的外掛 -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.21/jquery.csv.min.js"></script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        
        .mapboxgl-ctrl-reset {
        font-size: 18px; line-height: 28px;    /* 文字置中 */
        }
        .mapboxgl-ctrl-reset::before {
        content: "↺";               /* 也可換成 ⌂ 或 🏠 等 */
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        /* ----------- 地圖基本設定 ----------- */
        const centerCoord = [121.531, 25.041, 60];   // [lon, lat, elev]
        
        const initialView = {                      //  ← 依你的設定改值
            center: [121.5305, 25.04],               // 只有經緯度即可
            zoom:   17.5,
            pitch:  60,
            bearing: 0
            };
        mapboxgl.accessToken =
            "pk.eyJ1IjoicGlhb3BpYW9lbiIsImEiOiJjbTlsa2Y2d28wM2d4MmxyNzhqem12MWd1In0.NbcsNNsBZtV-pLab8nBtPg";

        const map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/piaopiaoen/cm9lof90y009n01soaal5dqzr",
            center: centerCoord,
            zoom: 17.5,
            pitch: 60,
            antialias: true,
            localIdeographFontFamily: "Noto Sans CJK TC",
            language: "zh-Hant"
        });
        /* ★★★ 加入指北針 ★★★ */
        const compassControl = new mapboxgl.NavigationControl({
            showZoom: false,        // 不顯示 + / − 按鈕；如需就改為 true
            visualizePitch: true    // 保留 pitch 指示
        });
        map.addControl(compassControl, 'top-left'); // 可改 'top-right' 等位置
        /* ★★★ 指北針結束 ★★★ */


     class ResetViewControl {
        onAdd(map) {
            this._map = map;

            // 外層容器（保留 Mapbox 樣式）
            const wrapper = document.createElement('div');
            wrapper.className = 'mapboxgl-ctrl mapboxgl-ctrl-group';

            // 按鈕
            const btn = document.createElement('button');
            btn.className = 'mapboxgl-ctrl-icon mapboxgl-ctrl-reset';
            btn.type  = 'button';
            btn.title = '回到初始視角';

            // 點擊事件：飛回初始參數
            btn.onclick = () => {
            map.flyTo({
                center:  initialView.center,
                zoom:    initialView.zoom,
                pitch:   initialView.pitch,
                bearing: initialView.bearing,
                duration: 1000            // 動畫 1 秒
            });
            };

            wrapper.appendChild(btn);
            this._btn = btn;
            return wrapper;
        }
        
        onRemove() {
            this._btn.parentNode.remove();
            this._map = undefined;
        }
    }
        map.addControl(new ResetViewControl(), 'top-left');





        /* ----------- 顏色對照 ----------- */
        const baseColors = [
            "#b2182b", //  3 以上 (hot)
            "#ef8a62", //  2 ~ 2.5
            "#fddbc7", //  1 ~ 1.5
            "#ffffff", // -0.5 ~ 0.5
            "#d1e5f0", // -1 ~ -0.5
            "#67a9cf", // -2 ~ -1
            "#2166ac"  // -3 以下 (cold)
        ];
        // 轉三維線性空間色碼（Three.js 內部使用）
        const colors = baseColors.map(hex =>
            new THREE.Color(hex).convertSRGBToLinear().getStyle()
        );

        function getPMVColor(pmv) {
            if (pmv >= 2.5) return colors[0];
            if (pmv >= 1.5) return colors[1];
            if (pmv >= 0.5) return colors[2];
            if (pmv >= -0.5) return colors[3];
            if (pmv >= -1.5) return colors[4];
            if (pmv >= -2.5) return colors[5];
            return colors[6];
        }

        /* ----------- 載入資料並繪製線段 ----------- */
        map.on("load", () => {
            map.addLayer({
                id: "custom_layer",
                type: "custom",
                renderingMode: "3d",
                onAdd: (map, mbxContext) => {
                    /* Threebox 初始化 */
                    window.tb = new Threebox(map, mbxContext, {
                        defaultLights: false,
                        realSunlight: false
                    });
                    const ambientLight = new THREE.AmbientLight(0xffffff, 2);
                    tb.add(ambientLight);

                    /* 讀取 */
                    $.getJSON("./data/0910M_P3.json", data => {
                        data.forEach(row => {
                            const start = [
                                parseFloat(row.start_lon),
                                parseFloat(row.start_lat),
                                1
                            ];
                            const end = [
                                parseFloat(row.end_lon),
                                parseFloat(row.end_lat),
                                1
                            ];
                            const pmv = parseFloat(row.pmv);

                            const line = tb.line({
                                geometry: [start, end],
                                color: getPMVColor(pmv),
                                width: 10
                            });
                            tb.add(line);
                        });
                    });

                },
                render: () => {
                    if (typeof tb !== "undefined") tb.update();
                }
            });
        });
    </script>
</body>

</html>
