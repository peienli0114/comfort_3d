<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Street Segments by PMV</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <!-- Mapbox GL JS & Threebox -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/jscastro76/threebox@v.2.2.2/dist/threebox.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/jscastro76/threebox@v.2.2.2/dist/threebox.css" rel="stylesheet" />

    <!-- jQuery + 讀 CSV 的外掛 -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.21/jquery.csv.min.js"></script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        /* ----------- 地圖基本設定 ----------- */
        const centerCoord = [121.531, 25.041, 60];   // [lon, lat, elev]
        mapboxgl.accessToken =
            "pk.eyJ1IjoicGlhb3BpYW9lbiIsImEiOiJjbTlsa2Y2d28wM2d4MmxyNzhqem12MWd1In0.NbcsNNsBZtV-pLab8nBtPg";

        const map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/piaopiaoen/cm9lof90y009n01soaal5dqzr",
            center: centerCoord,
            zoom: 17.5,
            pitch: 60,
            antialias: true,
            localIdeographFontFamily: "Noto Sans CJK TC",
            language: "zh-Hant"
        });

        /* ----------- 顏色對照 ----------- */
        const baseColors = [
            "#b2182b", //  3 以上 (hot)
            "#ef8a62", //  2 ~ 2.5
            "#fddbc7", //  1 ~ 1.5
            "#ffffff", // -0.5 ~ 0.5
            "#d1e5f0", // -1 ~ -0.5
            "#67a9cf", // -2 ~ -1
            "#2166ac"  // -3 以下 (cold)
        ];
        // 轉三維線性空間色碼（Three.js 內部使用）
        const colors = baseColors.map(hex =>
            new THREE.Color(hex).convertSRGBToLinear().getStyle()
        );

        function getPMVColor(pmv) {
            if (pmv >= 2.5) return colors[0];
            if (pmv >= 1.5) return colors[1];
            if (pmv >= 0.5) return colors[2];
            if (pmv >= -0.5) return colors[3];
            if (pmv >= -1.5) return colors[4];
            if (pmv >= -2.5) return colors[5];
            return colors[6];
        }

        /* ----------- 載入資料並繪製線段 ----------- */
        map.on("load", () => {
            map.addLayer({
                id: "custom_layer",
                type: "custom",
                renderingMode: "3d",
                onAdd: (map, mbxContext) => {
                    /* Threebox 初始化 */
                    window.tb = new Threebox(map, mbxContext, {
                        defaultLights: false,
                        realSunlight: false
                    });
                    const ambientLight = new THREE.AmbientLight(0xffffff, 2);
                    tb.add(ambientLight);

                    /* 讀取 CSV */
                    $.get("./data/9_10月下午均數值_加空間_加線段.csv", csvText => {
                        const rows = $.csv.toObjects(csvText);

                        rows.forEach(row => {
                            const start = [
                                parseFloat(row.start_lon),
                                parseFloat(row.start_lat),
                                1          // z = 1 m，略高於地面
                            ];
                            const end = [
                                parseFloat(row.end_lon),
                                parseFloat(row.end_lat),
                                1
                            ];
                            const pmv = parseFloat(row.pmv);

                            const line = tb.line({
                                geometry: [start, end],
                                color: getPMVColor(pmv),
                                width: 10              // 線寬（meters）
                            }); 
                            tb.add(line);
                        });
                    });
                },
                render: () => {
                    if (typeof tb !== "undefined") tb.update();
                }
            });
        });
    </script>
</body>

</html>
